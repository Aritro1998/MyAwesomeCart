{% extends 'shop/base.html' %}
{% block title %}Checkout{% endblock %}
{% block body %}
    {% load static %}
    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
        <symbol id="exclamation-triangle-fill" viewBox="0 0 16 16">
        <path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/>
        </symbol>
    </svg>
    <div class="container">
        <div class="col my-5">
            <h3 class="my-4">STEP 1: MyAwesomeCart Express Checkout - Review Your Cart Items</h3>
            {% comment %} <ol class="list-group list-group-numbered mx-5" id="items">
            </ol> {% endcomment %}
            <table class='table mx-5  align-middle' id="items">
                <thead>
                    <tr>
                        <th scope='col'>#</th>
                        <th scope='col'>Product</th>
                        <th scope='col'>Qty.</th>
                        <th scope='col'>Price</th>
                    </tr>
                </thead>
            </table>
        </div>
        <div class="col my-5">
            <h3 class="my-4">STEP 2: MyAwesomeCart Express Checkout - Enter Address & Other Details</h3>
            <form class="row g-3 mx-5 needs-validation"
                  method="post"
                  action="/shop/checkout/"
                  id="form"
                  novalidate>
                {% csrf_token %}
                <input type="hidden" name="itemsJson" id="itemsJson">
                <div class="col-md-4">
                    <label for="inputName" class="form-label">Name</label>
                    <input type="name"
                           class="form-control"
                           id="inputName"
                           name="inputName"
                           placeholder="Jhon Doe"
                           required>
                    <div class="invalid-feedback">This field can't be empty.</div>
                </div>
                <div class="col-md-4">
                    <label for="inputPhone" class="form-label">Phone</label>
                    <input type="tel"
                           class="form-control"
                           id="inputPhone"
                           name="inputPhone"
                           placeholder="833XXXXXX1"
                           required>
                    <div class="invalid-feedback">This field can't be empty.</div>
                </div>
                <div class="col-md-4">
                    <label for="inputEmail" class="form-label">Email</label>
                    <input type="email"
                           class="form-control"
                           id="inputEmail"
                           name="inputEmail"
                           placeholder="abc@email.com"
                           required>
                    <div class="invalid-feedback">This field can't be empty.</div>
                </div>
                <div class="col-12">
                    <label for="inputAddress" class="form-label">Address</label>
                    <input type="text"
                           class="form-control"
                           id="inputAddress"
                           name="inputAddress"
                           placeholder="1234 Main St"
                           required>
                    <div class="invalid-feedback">This field can't be empty.</div>
                </div>
                <div class="col-12">
                    <label for="inputAddress2" class="form-label">Address Line 2</label>
                    <input type="text"
                           class="form-control"
                           id="inputAddress2"
                           name="inputAddress2"
                           placeholder="Apartment, studio, or floor">
                </div>
                <div class="col-md-6">
                    <label for="inputCity" class="form-label">City</label>
                    <input type="text"
                           class="form-control"
                           id="inputCity"
                           name="inputCity"
                           required>
                    <div class="invalid-feedback">This field can't be empty.</div>
                </div>
                <div class="col-md-4">
                    <label for="inputState" class="form-label">State</label>
                    <select id="inputState" class="form-select" name="inputState" required>
                        <option selected disabled value="">
                            Choose...
                        </option>
                        <option value="Andhra Pradesh">
                            Andhra Pradesh
                        </option>
                        <option value="Andaman and Nicobar Islands">
                            Andaman and Nicobar Islands
                        </option>
                        <option value="Arunachal Pradesh">
                            Arunachal Pradesh
                        </option>
                        <option value="Assam">
                            Assam
                        </option>
                        <option value="Bihar">
                            Bihar
                        </option>
                        <option value="Chandigarh">
                            Chandigarh
                        </option>
                        <option value="Chhattisgarh">
                            Chhattisgarh
                        </option>
                        <option value="Dadar and Nagar Haveli">
                            Dadar and Nagar Haveli
                        </option>
                        <option value="Daman and Diu">
                            Daman and Diu
                        </option>
                        <option value="Delhi">
                            Delhi
                        </option>
                        <option value="Lakshadweep">
                            Lakshadweep
                        </option>
                        <option value="Puducherry">
                            Puducherry
                        </option>
                        <option value="Goa">
                            Goa
                        </option>
                        <option value="Gujarat">
                            Gujarat
                        </option>
                        <option value="Haryana">
                            Haryana
                        </option>
                        <option value="Himachal Pradesh">
                            Himachal Pradesh
                        </option>
                        <option value="Jammu and Kashmir">
                            Jammu and Kashmir
                        </option>
                        <option value="Jharkhand">
                            Jharkhand
                        </option>
                        <option value="Karnataka">
                            Karnataka
                        </option>
                        <option value="Kerala">
                            Kerala
                        </option>
                        <option value="Madhya Pradesh">
                            Madhya Pradesh
                        </option>
                        <option value="Maharashtra">
                            Maharashtra
                        </option>
                        <option value="Manipur">
                            Manipur
                        </option>
                        <option value="Meghalaya">
                            Meghalaya
                        </option>
                        <option value="Mizoram">
                            Mizoram
                        </option>
                        <option value="Nagaland">
                            Nagaland
                        </option>
                        <option value="Odisha">
                            Odisha
                        </option>
                        <option value="Punjab">
                            Punjab
                        </option>
                        <option value="Rajasthan">
                            Rajasthan
                        </option>
                        <option value="Sikkim">
                            Sikkim
                        </option>
                        <option value="Tamil Nadu">
                            Tamil Nadu
                        </option>
                        <option value="Telangana">
                            Telangana
                        </option>
                        <option value="Tripura">
                            Tripura
                        </option>
                        <option value="Uttar Pradesh">
                            Uttar Pradesh
                        </option>
                        <option value="Uttarakhand">
                            Uttarakhand
                        </option>
                        <option value="West Bengal">
                            West Bengal
                        </option>
                    </select>
                    <div class="invalid-feedback">Please select valid state.</div>
                </div>
                <div class="col-md-2">
                    <label for="inputZip" class="form-label">Pin</label>
                    <input type="text"
                           class="form-control"
                           id="inputZip"
                           name="inputZip"
                           required>
                    <div class="invalid-feedback">Please select valid state.</div>
                </div>
                <div class="col-12">
                    <button type="submit" class="btn btn-primary" id="submitBtn">Place Order</button>
                </div>
            </form>
        </div>
    </div>
{% endblock %}
{% block js %}
    <script>
        //Initialize when the webpage is loaded
        if (localStorage.getItem('cart') != null) {
            var cart = JSON.parse(localStorage.getItem('cart'));
            var cartCount = JSON.parse(localStorage.getItem('cartCount'));
            if (localStorage.getItem('cartCount') < 1)
                clearCart();
        } else {
            cart = {};
            clearCart();
        }
        var sum=0;
        var i = 1;
        for (item in cart) {
            let name = cart[item][1];
            let qty = cart[item][0];
            let price = qty * cart[item][2];
            sum = sum + price;
            {% comment %} let htmlString = `<li class="list-group-item d-flex justify-content-between align-items-start">
                                    <div class="ms-2 me-auto">
                                        <div class="fw-bold">${name}</div>       
                                    </div>
                                    <span class="badge bg-primary rounded-pill">${qty}</span>
                                </li>` {% endcomment %}
            let htmlString = `<tbody>
                                <tr>
                                    <th scope='row'>${i}</th>
                                    <td>${name}</td>
                                    <td>${qty}</td>
                                    <td>₹${price}</td>
                                </tr>
                            </tbody>`;
            i = i + 1;
            $('#items').append(htmlString);
        }

        $('#items').append(`<tbody class="table-active">
                                <tr>
                                    <th scope='row' colspan="2">Total :</th>
                                    <td><b>${cartCount}</b></td>
                                    <td><b>₹${sum}</b></td>
                                </tr>
                            </tbody>`);

        $('#itemsJson').val(JSON.stringify(cart));
        {% if thank %}
                console.log("Order placed and cart cleared");
                clearCart();
                window.location.href = "/shop/thankyou/?id="+{{id}}; 
        {% endif %}

        //Clear cart button in the popover
        function clearCart() {
            console.log("Clear cart in checkout");
            document.getElementById("submitBtn").classList.add("disabled");
            htmlString = `<div class="alert alert-warning d-flex align-items-center mx-5" role="alert">
                            <svg class="bi flex-shrink-0 me-2" role="img" aria-label="Warning:"><use xlink:href="#exclamation-triangle-fill"/></svg>
                             <div><h3>Your cart is empty. Please add items to your cart.</h3></div>
                        </div>`
            $('#items').replaceWith(htmlString);
            cart = JSON.parse(localStorage.getItem('cart'));
            localStorage.clear();
            cart = {};
            cartCount = 0;
            pophtmlStr = "<h6>Your cart is empty</h6>";
            updateCart(cart);
        }
        
        // Example starter JavaScript for disabling form submissions if there are invalid fields
        (function() {
            'use strict'

            // Fetch all the forms we want to apply custom Bootstrap validation styles to
            var forms = document.querySelectorAll('.needs-validation')

            // Loop over them and prevent submission
            Array.prototype.slice.call(forms)
                .forEach(function(form) {
                    form.addEventListener('submit', function(event) {
                        if (!form.checkValidity()) {
                            event.preventDefault()
                            event.stopPropagation()
                        }
                        form.classList.add('was-validated')
                    }, false)
                })
        })()
    </script>
{% endblock %}
